{% extends 'caisse/base.html' %}
{% block title %}Caisse{% endblock %}
{% block extra_css %}
<style>
    .produit-btn { background: #007bff !important; color: white !important; margin: 5px; width: 150px; height: 100px; font-size: 1.2em; border-radius: 8px; position: relative; }
    .produit-btn.bg-danger { background: #dc3545 !important; }
    .produit-btn .delete-btn { position: absolute; top: 5px; right: 5px; display: none; }
    .produit-btn:hover .delete-btn { display: block; }
    .total-fixed { position: fixed; top: 56px; left: 0; width: 100%; background: #28a745; color: white; text-align: center; padding: 10px; z-index: 1000; font-size: 2em; }
    .content-padding { padding-top: 100px; }
    @media (max-width: 768px) { .produit-btn { width: 100%; height: auto; } }
</style>
{% endblock %}
{% block content %}
<div class="content-padding"></div>
<div class="total-fixed">Total: <span id="total-live">{{ total }} €</span></div>
<div class="container mt-5">
    <div class="row">
        <div class="col-md-6">
            <h3>Articles</h3>
            <div class="d-flex flex-wrap">
                {% for produit in produits %}
                    {% if produit.stock <= 5 %}
                        <div class="text-center m-2 position-relative">
                            <button class="btn produit-btn bg-danger" onclick="ajouterAuPanier({{ produit.id }})">
                                {{ produit.nom }}<br>{{ produit.prix }} €<br><small>Stock: {{ produit.stock }}</small>
                            </button>
                            <a href="{% url 'reassort_produit' produit.id %}" class="btn btn-warning btn-sm d-block mt-1">Réassort</a>
                            <form method="post" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" name="supprimer_produit" value="{{ produit.id }}" class="btn btn-danger btn-sm delete-btn">X</button>
                            </form>
                        </div>
                    {% else %}
                        <div class="text-center m-2 position-relative">
                            <button class="btn produit-btn" onclick="ajouterAuPanier({{ produit.id }})">
                                {{ produit.nom }}<br>{{ produit.prix }} €<br><small>Stock: {{ produit.stock }}</small>
                            </button>
                            <form method="post" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" name="supprimer_produit" value="{{ produit.id }}" class="btn btn-danger btn-sm delete-btn">X</button>
                            </form>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <form method="post" class="mt-3">
                {% csrf_token %}
                <input name="nom" placeholder="Nom produit" class="form-control mb-2">
                <input name="prix" type="number" step="0.01" placeholder="Prix" class="form-control mb-2">
                <input name="stock" type="number" placeholder="Stock" class="form-control mb-2">
                <button type="submit" name="ajouter_nouveau" class="btn btn-success">Ajouter Nouveau</button>
            </form>
        </div>
        <div class="col-md-6">
            <h3>Panier</h3>
            <ul id="panier-list" class="list-group">
                {% include 'caisse/panier_list.html' with panier_ventes=panier_ventes %}
            </ul>
            {% if not panier_ventes %}
                <p class="text-muted">Panier vide. Ajoutez des articles !</p>
            {% endif %}
            <form method="post" class="mt-3">
                {% csrf_token %}
                <h4>Remise Totale</h4>
                <select name="type_remise" class="form-select mb-2">
                    <option value="pourcentage">%</option>
                    <option value="fixe">Fixe</option>
                </select>
                <input name="valeur_remise" type="number" step="0.01" class="form-control mb-2">
                <button type="submit" name="appliquer_remise" class="btn btn-warning">Appliquer</button>
            </form>
            <form method="post" class="mt-3">
                {% csrf_token %}
                <button type="submit" name="vider_panier" class="btn btn-secondary mb-2">Vider Panier</button>
            </form>
            <form method="post" class="mt-3" onsubmit="return validatePaiement()">
                {% csrf_token %}
                <h4>Paiement</h4>
                <p id="reste-a-payer">Reste à payer: <span id="reste-value">{{ total }}</span> €</p>
                <p id="paye-value">Payé: 0 €</p>
                <input id="montant-input" type="number" step="0.01" class="form-control mb-2" placeholder="Montant">
                <div class="d-flex justify-content-between mb-2">
                    {% for value, label in modes_paiement %}
                        <button type="button" class="btn btn-secondary" onclick="addPaiement('{{ value }}')">{{ label }}</button>
                    {% endfor %}
                </div>
                <ul id="paiements-list" class="list-group mb-2">
                </ul>
                <button type="submit" name="payer" class="btn btn-primary">Confirmer Paiement</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    let paiements = [];

    function addPaiement(mode) {
        let montant = parseFloat(document.getElementById('montant-input').value) || 0;
        if (montant > 0) {
            paiements.push({mode: mode, montant: montant});
            updatePaiementsList();
            updateReste();
            document.getElementById('montant-input').value = '';
        } else {
            alert('Montant invalide');
        }
    }

    function updatePaiementsList() {
        let html = '';
        paiements.forEach((p, i) => {
            html += `<li class="list-group-item d-flex justify-content-between">
                        ${p.mode} : ${p.montant.toFixed(2)} €
                        <button type="button" class="btn btn-danger btn-sm" onclick="removePaiement(${i})">X</button>
                     </li>`;
        });
        document.getElementById('paiements-list').innerHTML = html;
    }

    function removePaiement(index) {
        paiements.splice(index, 1);
        updatePaiementsList();
        updateReste();
    }

    function updateReste() {
        let total = parseFloat('{{ total }}') || 0;
        let sum = paiements.reduce((acc, p) => acc + p.montant, 0);
        let reste = total - sum;
        document.getElementById('reste-value').textContent = reste.toFixed(2);
        document.getElementById('paye-value').textContent = 'Payé: ' + sum.toFixed(2) + ' €';
        if (reste < 0) {
            document.getElementById('reste-a-payer').style.color = 'red';
        } else {
            document.getElementById('reste-a-payer').style.color = 'black';
        }
    }

    function validatePaiement() {
        let total = parseFloat('{{ total }}') || 0;
        let sum = paiements.reduce((acc, p) => acc + p.montant, 0);
        if (Math.abs(sum - total) > 0.01) {
            alert('Le montant payé doit égaler le total du panier !');
            return false;
        }
        paiements.forEach((p, i) => {
            let inputMode = document.createElement('input');
            inputMode.name = `mode_paiement_${i}`;
            inputMode.value = p.mode;
            inputMode.type = 'hidden';
            document.querySelector('form[method="post"][onsubmit="return validatePaiement()"]').appendChild(inputMode);

            let inputMontant = document.createElement('input');
            inputMontant.name = `montant_${i}`;
            inputMontant.value = p.montant.toFixed(2);
            inputMontant.type = 'hidden';
            document.querySelector('form[method="post"][onsubmit="return validatePaiement()"]').appendChild(inputMontant);
        });
        return true;
    }

    function ajouterAuPanier(produitId) {
        const formData = new FormData();
        formData.append('produit', produitId);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch('/caisse/', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('total-live').textContent = data.total + ' €';
                document.getElementById('panier-list').innerHTML = data.panier_html;
                const emptyMsg = document.querySelector('.text-muted');
                if (emptyMsg) {
                    emptyMsg.style.display = data.panier_html.trim() ? 'none' : 'block';
                }
                updateReste();
            } else {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('Erreur AJAX:', error);
            alert('Erreur réseau. Réessayez.');
        });
    }
</script>
{% endblock %}